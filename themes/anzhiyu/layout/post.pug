extends includes/layout.pug

block content
  #post
    if top_img === false || page.bilibili_bg
      include includes/header/post-info.pug
    if theme.post_head_ai_description
      include includes/anzhiyu/ai-info.pug
    - let url = page.copyright_url || page.permalink
    article#article-container.post-content(itemscope itemtype=url_for(url))
      header
        if (theme.post_meta.post.categories && page.categories && page.categories.data.length > 0)
          each item, index in page.categories.data
            a(href=url_for(item.path) itemprop="url").post-meta-categories #[=item.name]
        if (theme.post_meta.page.tags)
          each item, index in page.tags.data
            a(href=url_for(item.path) tabindex="-1" itemprop="url")=item.name
        h1#CrawlerTitle(itemprop="name headline")= page.title || _p('no_title')
        - let author = page.copyright_author || config.author
        span(itemprop="author" itemscope itemtype="http://schema.org/Person")=author
        if (theme.post_meta.post.date_type)
          if (theme.post_meta.post.date_type === 'both')
            time(itemprop="dateCreated datePublished" datetime=date_xml(page.date) title=_p('post.created') + ' ' + full_date(page.date))=date(page.date, config.date_format)
            time(itemprop="dateCreated datePublished" datetime=date_xml(page.updated) title=_p('post.updated') + ' ' + full_date(page.updated))=date(page.updated, config.date_format)
          else
            - let data_type_update = theme.post_meta.post.date_type === 'updated'
            - let date_type = data_type_update ? 'updated' : 'date'
            time(itemprop="dateCreated datePublished" datetime=date_xml(page[date_type]) title=date_title + ' ' + full_date(page[date_type]))=date(page[date_type], config.date_format)
      
      style.
        .nananiji-trans-container {
          text-align: left;
          margin: 20px 0 30px 0;
          display: none;
        }
        #nananiji-lang-toggle {
          background: #008CD2; 
          color: #fff;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: bold;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          line-height: 1.5;
          box-shadow: 0 2px 4px rgba(76, 196, 219, 0.3); 
          transition: all 0.3s ease;
        }
        #nananiji-lang-toggle:hover {
          background: #00AACC; 
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(76, 196, 219, 0.4);
        }
        .nananiji-trans-disclaimer {
          font-size: 12px;
          color: #aaa;
          margin-top: 6px;
          margin-bottom: 0;
          margin-left: 2px;
          display: none;
        }
        .article-original-jp, .article-translated-cn {
          animation: fadePlain 0.3s ease;
        }
        @keyframes fadePlain { 
          from { opacity: 0; } 
          to { opacity: 1; } 
        }
        .nananiji-img-placeholder {
          display: inline-block;
          width: 0;
          height: 0;
          overflow: hidden;
        }
        .nananiji-img-anchor {
          display: none; 
        }
        .article-translated-cn {
           white-space: pre-wrap; 
           line-height: 1.8;
           font-size: 15px;
        }

      div.nananiji-trans-container
        button#nananiji-lang-toggle(type="button") 
          span AI翻译至中文
        p.nananiji-trans-disclaimer ✨ 由 Google Gemini 提供翻译 · 仅供参考

      !=page.content

      script.
        function runNananijiTranslator() {
          const cnBox = document.querySelector('.article-translated-cn');
          const btnContainer = document.querySelector('.nananiji-trans-container');
          
          if (!cnBox || !btnContainer) return;

          btnContainer.style.display = 'block';

          setupImageAnchors();
          
          const btn = document.getElementById('nananiji-lang-toggle');
          if (btn) {
             btn.onclick = toggleNananijiLanguage;
          }
        }

        // 获取图片真实链接
        function getRealSrc(img) {
          return img.getAttribute('data-lazy-src') || 
                 img.getAttribute('data-src') || 
                 img.getAttribute('src');
        }

        function setupImageAnchors() {
          const jpImages = document.querySelectorAll('.article-original-jp img');
          
          jpImages.forEach((img) => {
            let wrapper = img.closest('a');
            const realSrc = getRealSrc(img);

            if (!wrapper) {
               wrapper = document.createElement('a');
               wrapper.href = realSrc; 
               wrapper.setAttribute('data-fancybox', 'gallery');
               
               const caption = img.getAttribute('alt') || '';
               wrapper.setAttribute('data-caption', caption);
               wrapper.setAttribute('data-thumb', realSrc);

               if (img.parentNode) {
                 img.parentNode.insertBefore(wrapper, img);
                 wrapper.appendChild(img);
               }
            } else {
               const currentHref = wrapper.getAttribute('href');
               if (!currentHref || currentHref.startsWith('data:image')) {
                 wrapper.href = realSrc;
                 wrapper.setAttribute('data-thumb', realSrc);
               }
               if (!wrapper.getAttribute('data-fancybox')) {
                 wrapper.setAttribute('data-fancybox', 'gallery');
               }
            }
            
            if (wrapper.getAttribute('data-nananiji-processed')) return;

            const anchor = document.createElement('span');
            anchor.className = 'nananiji-img-anchor';
            wrapper.parentNode.insertBefore(anchor, wrapper);
            wrapper.setAttribute('data-nananiji-processed', 'true');
            
            wrapper._nananijiAnchor = anchor;
          });
        }

        function toggleNananijiLanguage() {
          const btn = document.getElementById('nananiji-lang-toggle');
          const disclaimer = document.querySelector('.nananiji-trans-disclaimer');
          const jpBox = document.querySelector('.article-original-jp');
          const cnBox = document.querySelector('.article-translated-cn');

          if (!jpBox || !cnBox) return;

          const isJpVisible = jpBox.style.display !== 'none';

          if (isJpVisible) {
            moveImagesToNewContainer(jpBox, cnBox);
            jpBox.style.display = 'none';
            cnBox.style.display = 'block';
            if(btn) btn.innerHTML = '<span>显示原文</span>';
            if(disclaimer) disclaimer.style.display = 'block';
          } else {
            // 切回日文：把图片还回原位
            returnImagesToOriginal(jpBox);
            jpBox.style.display = 'block';
            cnBox.style.display = 'none';
            if(btn) btn.innerHTML = '<span>AI翻译至中文</span>';
            if(disclaimer) disclaimer.style.display = 'none';
          }
        }

        function moveImagesToNewContainer(sourceContainer, targetContainer) {
           const processedImages = sourceContainer.querySelectorAll('a[data-nananiji-processed="true"]');
           const placeholders = targetContainer.querySelectorAll('.nananiji-img-placeholder');
           
           processedImages.forEach((imgNode, index) => {
             if (index < placeholders.length) {
               const ph = placeholders[index];
               ph.parentNode.insertBefore(imgNode, ph);
             }
           });
           refreshLightbox();
        }

        function returnImagesToOriginal(sourceContainer) {
           const movedImages = document.querySelectorAll('.article-translated-cn a[data-nananiji-processed="true"]');
           
           movedImages.forEach((imgNode) => {
             if (imgNode._nananijiAnchor && imgNode._nananijiAnchor.parentNode) {
               imgNode._nananijiAnchor.parentNode.insertBefore(imgNode, imgNode._nananijiAnchor.nextSibling);
             }
           });
           refreshLightbox();
        }


        function refreshLightbox() {
          if (typeof Fancybox !== 'undefined') {
            Fancybox.unbind('[data-fancybox]'); 
            Fancybox.bind('[data-fancybox]', {
              groupAll: true,
              Hash: false,
              Thumbs: { autoStart: false },
            });
          }
        }


        document.addEventListener('DOMContentLoaded', () => {
           setTimeout(runNananijiTranslator, 100); 
        });

        document.addEventListener('pjax:complete', () => {
           setTimeout(runNananijiTranslator, 100);
        });

    include includes/post/post-copyright.pug

    //- ad
    if theme.ad && theme.ad.post
      .ads-wrap!=theme.ad.post

    if theme.post_pagination
      include includes/pagination.pug
    if theme.related_post && theme.related_post.enable
      != related_posts(page,site.posts)

    if page.comments !== false && theme.comments && theme.comments.use
      - var commentsJsLoad = true
      !=partial('includes/third-party/comments/index', {}, {cache: true})