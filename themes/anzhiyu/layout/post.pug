extends includes/layout.pug

block content
  #post
    if top_img === false || page.bilibili_bg
      include includes/header/post-info.pug
    if theme.post_head_ai_description
      include includes/anzhiyu/ai-info.pug
    - let url = page.copyright_url || page.permalink
    article#article-container.post-content(itemscope itemtype=url_for(url))
      header
        if (theme.post_meta.post.categories && page.categories && page.categories.data.length > 0)
          each item, index in page.categories.data
            a(href=url_for(item.path) itemprop="url").post-meta-categories #[=item.name]
        if (theme.post_meta.page.tags)
          each item, index in page.tags.data
            a(href=url_for(item.path) tabindex="-1" itemprop="url")=item.name
        h1#CrawlerTitle(itemprop="name headline")= page.title || _p('no_title')
        - let author = page.copyright_author || config.author
        span(itemprop="author" itemscope itemtype="http://schema.org/Person")=author
        if (theme.post_meta.post.date_type)
          if (theme.post_meta.post.date_type === 'both')
            time(itemprop="dateCreated datePublished" datetime=date_xml(page.date) title=_p('post.created') + ' ' + full_date(page.date))=date(page.date, config.date_format)
            time(itemprop="dateCreated datePublished" datetime=date_xml(page.updated) title=_p('post.updated') + ' ' + full_date(page.updated))=date(page.updated, config.date_format)
          else
            - let data_type_update = theme.post_meta.post.date_type === 'updated'
            - let date_type = data_type_update ? 'updated' : 'date'
            time(itemprop="dateCreated datePublished" datetime=date_xml(page[date_type]) title=date_title + ' ' + full_date(page[date_type]))=date(page[date_type], config.date_format)
      
      //- === 1. æ ·å¼ ===
      style.
        .nananiji-trans-container {
          text-align: left;
          margin: 20px 0 30px 0;
          display: none;
        }
        #nananiji-lang-toggle {
          background: #4CC4DB;
          color: #fff;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: bold;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          line-height: 1.5;
          box-shadow: none; 
          transition: background 0.2s ease;
        }
        #nananiji-lang-toggle:hover {
          background: #3bbacf;
        }
        .nananiji-trans-disclaimer {
          font-size: 12px;
          color: #aaa;
          margin-top: 6px;
          margin-bottom: 0;
          margin-left: 2px;
          display: none;
        }
        .article-original-jp, .article-translated-cn {
          animation: fadePlain 0.3s ease;
        }
        @keyframes fadePlain { 
          from { opacity: 0; } 
          to { opacity: 1; } 
        }
        .nananiji-img-placeholder {
          display: inline-block;
          width: 0;
          height: 0;
          overflow: hidden;
        }
        .nananiji-img-anchor {
          display: none; 
        }

      //- æŒ‰é’®å®¹å™¨
      div.nananiji-trans-container
        button#nananiji-lang-toggle(onclick="toggleNananijiLanguage()") 
          span ğŸ‡¨ğŸ‡³ ç¿»è¯‘æˆä¸­æ–‡
        p.nananiji-trans-disclaimer âœ¨ ç”± Google Gemini æä¾›ç¿»è¯‘ Â· ä»…ä¾›å‚è€ƒ

      //- === 2. æ­£æ–‡ ===
      !=page.content

      //- === 3. ä¿®å¤è„šæœ¬ (æ”¯æŒ LazyLoad) ===
      script.
        let nananijiImageMap = [];
        let nananijiInitialized = false;

        function initNananijiTranslator() {
          const cnBox = document.querySelector('.article-translated-cn');
          const btnContainer = document.querySelector('.nananiji-trans-container');
          
          if (cnBox && btnContainer) {
            btnContainer.style.display = 'block';
            if (!nananijiInitialized) {
              setupImageAnchors();
              nananijiInitialized = true;
            }
          }
        }

        // æ ¸å¿ƒä¿®å¤ï¼šè·å–çœŸå® URL
        function getRealSrc(img) {
          // ä¼˜å…ˆé¡ºåºï¼šdata-lazy-src -> data-src -> src
          return img.getAttribute('data-lazy-src') || 
                 img.getAttribute('data-src') || 
                 img.getAttribute('src');
        }

        function setupImageAnchors() {
          const jpImages = document.querySelectorAll('.article-original-jp img');
          nananijiImageMap = []; 

          jpImages.forEach((img) => {
            let wrapper = img.closest('a');
            
            // è·å–çœŸå®é“¾æ¥ï¼ˆé¿å¼€ base64 å ä½ç¬¦ï¼‰
            const realSrc = getRealSrc(img);

            // 1. å¦‚æœæ²¡æœ‰ wrapperï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª
            if (!wrapper) {
               wrapper = document.createElement('a');
               wrapper.href = realSrc; // âœ¨ è¿™é‡Œç”¨äº†çœŸå®é“¾æ¥ï¼
               wrapper.setAttribute('data-fancybox', 'gallery');
               
               const caption = img.getAttribute('alt') || '';
               wrapper.setAttribute('data-caption', caption);
               wrapper.setAttribute('data-thumb', realSrc); // ç¼©ç•¥å›¾ä¹Ÿç»™ä¸Š

               if (img.parentNode) {
                 img.parentNode.insertBefore(wrapper, img);
                 wrapper.appendChild(img);
               }
            } else {
               // 2. å¦‚æœæœ¬æ¥å°±æœ‰ wrapperï¼Œä½† href æ˜¯ base64 å ä½ç¬¦ï¼Œå¼ºåˆ¶ä¿®æ­£å®ƒ
               const currentHref = wrapper.getAttribute('href');
               if (!currentHref || currentHref.startsWith('data:image')) {
                 wrapper.href = realSrc; // âœ¨ å¼ºåˆ¶ä¿®æ­£ï¼
                 wrapper.setAttribute('data-thumb', realSrc);
               }
               
               if (!wrapper.getAttribute('data-fancybox')) {
                 wrapper.setAttribute('data-fancybox', 'gallery');
               }
            }
            
            const targetNode = wrapper;

            if (targetNode.getAttribute('data-nananiji-processed')) return;

            // æ‰“æ¡©
            const anchor = document.createElement('span');
            anchor.className = 'nananiji-img-anchor';
            
            targetNode.parentNode.insertBefore(anchor, targetNode);
            targetNode.setAttribute('data-nananiji-processed', 'true');

            nananijiImageMap.push({
              node: targetNode,
              anchor: anchor
            });
          });
        }

        function toggleNananijiLanguage() {
          const btn = document.getElementById('nananiji-lang-toggle');
          const disclaimer = document.querySelector('.nananiji-trans-disclaimer');
          const jpBox = document.querySelector('.article-original-jp');
          const cnBox = document.querySelector('.article-translated-cn');

          if (!jpBox || !cnBox) return;

          const isJpVisible = jpBox.style.display !== 'none';

          if (isJpVisible) {
            moveImagesToPlaceholders();
            jpBox.style.display = 'none';
            cnBox.style.display = 'block';
            btn.innerHTML = '<span>ğŸ‡¯ğŸ‡µ æ˜¾ç¤ºåŸæ–‡</span>';
            disclaimer.style.display = 'block';
          } else {
            returnImagesToAnchors();
            jpBox.style.display = 'block';
            cnBox.style.display = 'none';
            btn.innerHTML = '<span>ğŸ‡¨ğŸ‡³ ç¿»è¯‘æˆä¸­æ–‡</span>';
            disclaimer.style.display = 'none';
          }
        }

        function moveImagesToPlaceholders() {
          const placeholders = document.querySelectorAll('.article-translated-cn .nananiji-img-placeholder');
          
          nananijiImageMap.forEach((item, index) => {
            if (index < placeholders.length) {
              const ph = placeholders[index];
              ph.parentNode.insertBefore(item.node, ph);
            }
          });
          refreshLightbox();
        }

        function returnImagesToAnchors() {
          nananijiImageMap.forEach((item) => {
            if (item.anchor && item.anchor.parentNode) {
              item.anchor.parentNode.insertBefore(item.node, item.anchor.nextSibling);
            }
          });
          refreshLightbox();
        }

        function refreshLightbox() {
          if (typeof Fancybox !== 'undefined') {
            Fancybox.unbind('[data-fancybox]'); 
            Fancybox.bind('[data-fancybox]', {
              groupAll: true,
              Hash: false,
              Thumbs: { autoStart: false },
            });
          }
        }

        setTimeout(initNananijiTranslator, 100);

    include includes/post/post-copyright.pug

    //- ad
    if theme.ad && theme.ad.post
      .ads-wrap!=theme.ad.post

    if theme.post_pagination
      include includes/pagination.pug
    if theme.related_post && theme.related_post.enable
      != related_posts(page,site.posts)

    if page.comments !== false && theme.comments && theme.comments.use
      - var commentsJsLoad = true
      !=partial('includes/third-party/comments/index', {}, {cache: true})